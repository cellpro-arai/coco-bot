<!DOCTYPE html>
<!--
  経費精算フォーム - React版 SPA
-->
<html>

<head>
  <base target="_top" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />

  <!-- React CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    main {
      flex: 1;
    }

    .required-label::after {
      content: " *";
      color: var(--pico-del-color);
    }

    .incident-card {
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }

    .incident-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--pico-card-box-shadow);
    }

    .text-truncate-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .text-truncate-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .text-center {
      text-align: center;
    }

    .text-muted {
      color: var(--pico-muted-color);
      font-size: 0.8rem;
    }

    .mb-0 {
      margin-bottom: 0;
    }

    .mb-2 {
      margin-bottom: 0.5rem;
    }

    .mb-3 {
      margin-bottom: 1rem;
    }

    .py-3 {
      padding-top: 1rem;
      padding-bottom: 1rem;
    }

    .py-5 {
      padding-top: 3rem;
      padding-bottom: 3rem;
    }

    .d-flex {
      display: flex;
    }

    .align-items-center {
      align-items: center;
    }

    .justify-content-center {
      justify-content: center;
    }

    .me-2 {
      margin-right: 0.5rem;
    }

    .commute-table-container {
      width: 100%;
      margin-top: 0.5rem;
    }

    .commute-table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .commute-table-header button {
      padding: 0.32rem 0.75rem;
      font-size: 0.82rem;
      line-height: 1;
      min-height: 1.35rem;
    }

    .commute-cards-grid {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      margin-top: 0.5rem;
    }

    .commute-card {
      background: var(--pico-card-background-color);
      border: 1px solid var(--pico-muted-border-color);
      border-radius: var(--pico-border-radius);
      padding: 0.4rem 0.5rem;
      transition: all 0.2s ease;
      display: grid;
      grid-template-columns: 160px 160px 160px 100px 120px 1fr;
      gap: 0.5rem;
      align-items: center;
      font-size: 0.85rem;
    }

    @media (max-width: 1199px) {
      .commute-card {
        grid-template-columns: 1fr 1fr 1fr;
        grid-template-rows: auto auto;
        gap: 0.4rem;
        max-width: 100%;
      }

      .commute-card-field:nth-child(1) {
        /* 日付 */
        grid-column: 1;
        grid-row: 1;
      }

      .commute-card-field:nth-child(2) {
        /* 最寄り駅 */
        grid-column: 2;
        grid-row: 1;
      }

      .commute-card-field:nth-child(3) {
        /* 訪問先駅 */
        grid-column: 3;
        grid-row: 1;
      }

      .commute-card-field:nth-child(4) {
        /* 区分 */
        grid-column: 1;
        grid-row: 2;
      }

      .commute-card-field:nth-child(5) {
        /* 片道の金額 */
        grid-column: 2;
        grid-row: 2;
      }

      .commute-card-actions {
        /* ボタン */
        grid-column: 3;
        grid-row: 2;
        justify-content: flex-end;
      }
    }

    .commute-card:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transform: translateY(-1px);
    }

    .commute-card-field {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .commute-card-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--pico-muted-color);
      margin-bottom: 0;
      line-height: 1;
    }

    .commute-card input,
    .commute-card select {
      width: 100%;
      box-sizing: border-box;
      padding: 0.2rem 0.4rem;
      font-size: 0.78rem;
      height: 1.4rem;
      line-height: 1.2;
      margin-bottom: 0;
    }

    .commute-card-actions {
      display: flex;
      gap: 0.35rem;
      justify-content: flex-end;
    }

    .commute-card-actions button {
      padding: 0.25rem 0.6rem;
      font-size: 0.75rem;
      margin-bottom: 0;
      white-space: nowrap;
      line-height: 1;
      min-height: 1.4rem;
    }

    .expense-table-container {
      width: 100%;
      margin-top: 0.5rem;
    }

    .expense-table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .expense-table-header button {
      padding: 0.32rem 0.75rem;
      font-size: 0.82rem;
      line-height: 1;
      min-height: 1.35rem;
    }

    .expense-cards-grid {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 0.5rem;
    }

    .expense-card {
      background: var(--pico-card-background-color);
      border: 1px solid var(--pico-muted-border-color);
      border-radius: var(--pico-border-radius);
      padding: 0.75rem;
      transition: all 0.2s ease;
      font-size: 0.85rem;
    }

    .expense-card:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transform: translateY(-1px);
    }

    .expense-card-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .expense-card-row-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .expense-card-row:last-child {
      margin-bottom: 0;
    }

    .expense-card-field {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .expense-card-field-full {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      grid-column: 1 / -1;
    }

    .expense-card-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--pico-muted-color);
      margin-bottom: 0;
      line-height: 1;
    }

    .expense-card input,
    .expense-card select {
      width: 100%;
      box-sizing: border-box;
      padding: 0.2rem 0.4rem;
      font-size: 0.78rem;
      height: 1.4rem;
      line-height: 1.2;
      margin-bottom: 0;
    }

    .expense-card input[type="file"] {
      padding: 0;
      font-size: 0.78rem;
      height: 1.4rem;
      line-height: 1.4rem;
    }

    .expense-card input[type="file"]::file-selector-button,
    .expense-card input[type="file"]::-webkit-file-upload-button {
      padding: 0.16rem 0.5rem;
      font-size: 0.78rem;
      height: 100%;
      line-height: 1.2;
    }

    .expense-card-actions {
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
      margin-top: 0.5rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--pico-muted-border-color);
    }

    .expense-card-actions button {
      padding: 0.3rem 0.75rem;
      font-size: 0.8rem;
      margin-bottom: 0;
      white-space: nowrap;
    }

    @media (max-width: 768px) {
      .expense-card-row,
      .expense-card-row-3 {
        grid-template-columns: 1fr;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
      }

      .expense-card {
        padding: 0.5rem;
      }

      .expense-card-actions {
        margin-top: 0.5rem;
        padding-top: 0.5rem;
      }
    }

    .work-schedule-input {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .work-schedule-input button {
      padding: 0.2rem 0.6rem;
      font-size: 0.85rem;
      line-height: 1;
      min-height: 1.6rem;
    }

    .work-schedule-input .file-name {
      font-size: 0.85rem;
      color: var(--pico-muted-color);
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const createEmptyCommuteEntry = () => ({
      date: '',
      origin: '',
      destination: '',
      amount: '',
      tripType: 'oneWay'
    });

    const createEmptyExpenseEntry = () => ({
      date: '',
      category: 'ebook',
      description: '',
      amount: '',
      receiptFile: null,
      certificateFile: null
    });

    const getDefaultSubmissionMonth = () => {
      const today = new Date();
      const day = today.getDate();

      // 7日以前の場合は先月を返す
      if (day <= 7) {
        today.setMonth(today.getMonth() - 1);
      }

      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      return `${year}-${month}`;
    };

    const getSubmissionMonthOptions = () => {
      const today = new Date();
      const options = [];

      // 前月、当月、翌月の3つの選択肢を生成
      for (let i = -1; i <= 1; i++) {
        const date = new Date(today.getFullYear(), today.getMonth() + i, 1);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const value = `${year}-${month}`;
        const label = `${year}年${month}月`;
        options.push({ value, label });
      }

      return options;
    };

    function App() {
      const [formData, setFormData] = useState({
        name: '',
        submissionMonth: getDefaultSubmissionMonth(),
        workScheduleFiles: [],
        workStartTime: '09:00',
        workEndTime: '18:00',
        officeFrequency: 'fullRemote',
        hasCommuterPass: 'no',
        nearestStation: '',
        workStation: '',
        monthlyFee: '',
        remarks: '',
        commuteEntries: [],
        expenseEntries: []
      });

      const [submitted, setSubmitted] = useState(false);
      const formRef = useRef(null);
      const workScheduleInputRef = useRef(null);

      const handleInputChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({
          ...prev,
          [name]: value
        }));
      };

      const handleWorkScheduleFilesChange = (e) => {
        const files = Array.from(e.target.files || []);
        if (files.length > 0) {
          setFormData(prev => ({
            ...prev,
            workScheduleFiles: [...prev.workScheduleFiles, ...files]
          }));
          // ファイル入力をリセットして同じファイルを再度選択できるようにする
          if (workScheduleInputRef.current) {
            workScheduleInputRef.current.value = '';
          }
        }
      };

      const removeWorkScheduleFile = (indexToRemove) => {
        setFormData(prev => ({
          ...prev,
          workScheduleFiles: prev.workScheduleFiles.filter((_, index) => index !== indexToRemove)
        }));
      };

      const handleWorkScheduleButtonClick = () => {
        if (workScheduleInputRef.current) {
          workScheduleInputRef.current.click();
        }
      };

      const handleCommuteEntryChange = (index, field, value) => {
        setFormData(prev => {
          const updated = prev.commuteEntries.map((entry, idx) => {
            if (idx !== index) {
              return entry;
            }
            return { ...entry, [field]: value };
          });
          return { ...prev, commuteEntries: updated };
        });
      };

      const addCommuteEntry = () => {
        setFormData(prev => ({
          ...prev,
          commuteEntries: [...prev.commuteEntries, createEmptyCommuteEntry()]
        }));
      };

      const removeCommuteEntry = (index) => {
        setFormData(prev => {
          const updated = prev.commuteEntries.filter((_, idx) => idx !== index);
          return { ...prev, commuteEntries: updated };
        });
      };

      const duplicateCommuteEntry = (index) => {
        setFormData(prev => {
          const target = prev.commuteEntries[index];
          const cloned = { ...target, date: '' };
          const updated = [...prev.commuteEntries];
          updated.splice(index + 1, 0, cloned);
          return { ...prev, commuteEntries: updated };
        });
      };

      const handleExpenseEntryChange = (index, field, value) => {
        setFormData(prev => {
          const updated = prev.expenseEntries.map((entry, idx) => {
            if (idx !== index) return entry;
            const nextEntry = { ...entry, [field]: value };
            if (!nextEntry.description && !nextEntry.amount) {
              nextEntry.receiptFile = null;
              nextEntry.certificateFile = null;
            }
            if (field === 'category' && value !== 'certification') {
              nextEntry.certificateFile = null;
            }
            return nextEntry;
          });
          return { ...prev, expenseEntries: updated };
        });
      };

      const handleExpenseReceiptChange = (index, file) => {
        setFormData(prev => {
          const updated = prev.expenseEntries.map((entry, idx) =>
            idx === index ? { ...entry, receiptFile: file } : entry
          );
          return { ...prev, expenseEntries: updated };
        });
      };

      const handleExpenseCertificateChange = (index, file) => {
        setFormData(prev => {
          const updated = prev.expenseEntries.map((entry, idx) =>
            idx === index ? { ...entry, certificateFile: file } : entry
          );
          return { ...prev, expenseEntries: updated };
        });
      };

      const addExpenseEntry = () => {
        setFormData(prev => ({
          ...prev,
          expenseEntries: [...prev.expenseEntries, createEmptyExpenseEntry()]
        }));
      };

      const removeExpenseEntry = (index) => {
        setFormData(prev => {
          const updated = prev.expenseEntries.filter((_, idx) => idx !== index);
          return { ...prev, expenseEntries: updated };
        });
      };

      const collectCommuteEntries = () => {
        const entries = [];

        for (const entry of formData.commuteEntries) {
          const hasValue =
            entry.date || entry.origin || entry.destination || entry.amount;
          if (!hasValue) {
            continue;
          }

          const isComplete =
            entry.date && entry.origin && entry.destination && entry.amount;
          if (!isComplete) {
            throw new Error('交通費の各項目（日時・最寄り駅・訪問先駅・金額）を入力してください。');
          }

          entries.push({ ...entry, tripType: entry.tripType || 'oneWay' });
        }

        return entries;
      };

      const collectExpenseEntries = async () => {
        const entries = [];

        for (const entry of formData.expenseEntries) {
          const hasValue = entry.date || entry.description || entry.amount;
          if (!hasValue) {
            continue;
          }

          if (!entry.date || !entry.description || !entry.amount) {
            throw new Error('経費の日付、内容、金額を入力してください。');
          }

          if (!entry.receiptFile) {
            throw new Error('経費には領収書の添付が必須です。');
          }

          const category = entry.category || 'other';

          if (category === 'certification' && !entry.certificateFile) {
            throw new Error('資格受験の経費には合格通知書の添付が必須です。');
          }

          const receiptFileData = await encodeFileToBase64(entry.receiptFile);

          if (!receiptFileData) {
            throw new Error('領収書の変換に失敗しました。');
          }

          let certificateFileData = null;
          if (category === 'certification') {
            certificateFileData = await encodeFileToBase64(entry.certificateFile);
            if (!certificateFileData) {
              throw new Error('合格通知書の変換に失敗しました。');
            }
          }

          entries.push({
            date: entry.date,
            category,
            description: entry.description,
            amount: entry.amount,
            receiptFile: receiptFileData,
            certificateFile: certificateFileData
          });
        }

        return entries;
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setSubmitted(true);

        try {
          // 勤務表ファイルをBase64エンコード
          const workScheduleFilesData = await Promise.all(
            formData.workScheduleFiles.map(file => encodeFileToBase64(file))
          );

          const commuteEntries = collectCommuteEntries();
          const expenseEntries = await collectExpenseEntries();

          // バックエンドに送信するデータを準備
          const expenseData = {
            name: formData.name,
            submissionMonth: formData.submissionMonth,
            workScheduleFiles: workScheduleFilesData,
            workStartTime: formData.workStartTime,
            workEndTime: formData.workEndTime,
            officeFrequency: formData.officeFrequency,
            hasCommuterPass: formData.hasCommuterPass,
            nearestStation: formData.nearestStation,
            workStation: formData.workStation,
            monthlyFee: formData.monthlyFee,
            remarks: formData.remarks,
            commuteEntries,
            expenseEntries
          };

          // Google Apps Scriptのバックエンド関数を呼び出し
          google.script.run
            .withSuccessHandler((result) => {
              alert(result.message);
              // フォームをリセット
              if (formRef.current) {
                formRef.current.reset();
              }
              setFormData({
                name: '',
                submissionMonth: getDefaultSubmissionMonth(),
                workScheduleFiles: [],
                workStartTime: '09:00',
                workEndTime: '18:00',
                officeFrequency: 'fullRemote',
                hasCommuterPass: 'no',
                nearestStation: '',
                workStation: '',
                monthlyFee: '',
                remarks: '',
                commuteEntries: [],
                expenseEntries: []
              });
              setSubmitted(false);
            })
            .withFailureHandler((error) => {
              alert('エラーが発生しました: ' + error.message);
              setSubmitted(false);
            })
            .submitExpense(expenseData);
        } catch (error) {
          alert('エラーが発生しました: ' + error.message);
          setSubmitted(false);
        }
      };

      const encodeFileToBase64 = (file) => {
        return new Promise((resolve, reject) => {
          if (!file) {
            resolve(null);
            return;
          }

          const reader = new FileReader();
          reader.onload = () => {
            const base64 = reader.result.split(',')[1];
            resolve({
              name: file.name,
              mimeType: file.type,
              data: base64
            });
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      };

      const hasCommuteEntries = formData.commuteEntries.length > 0;
      const hasExpenseEntries = formData.expenseEntries.length > 0;

      return (
        <>
          <main className="container">
            {/* ヘッダー */}
            <article className="text-center py-3">
              <div className="d-flex align-items-center justify-content-center mb-2">
                <i className="bi bi-receipt me-2" style={{ fontSize: '2rem', color: 'var(--pico-primary)' }}></i>
                <h1 className="mb-0">経費精算フォーム</h1>
              </div>
              <p className="mb-0">
                経費精算に必要な情報を入力してください
              </p>
            </article>

            {/* フォーム */}
            <article>
              <form ref={formRef} onSubmit={handleSubmit}>
                {/* 氏名 */}
                <legend className="required-label">氏名</legend>
                <label htmlFor="name">
                  <input
                    type="text"
                    id="name"
                    name="name"
                    value={formData.name}
                    onChange={handleInputChange}
                    required
                    placeholder="山田 太郎"
                  />
                </label>

                {/* 提出月 */}
                <fieldset>
                  <legend className="required-label">提出月</legend>
                  <label htmlFor="submissionMonth">
                    <select
                      id="submissionMonth"
                      name="submissionMonth"
                      value={formData.submissionMonth}
                      onChange={handleInputChange}
                      required
                    >
                      {getSubmissionMonthOptions().map(option => (
                        <option key={option.value} value={option.value}>
                          {option.label}
                        </option>
                      ))}
                    </select>
                  </label>
                </fieldset>

                {/* 勤務表 */}
                <fieldset>
                  <label htmlFor="workScheduleFile">勤務表</label>
                  <div className="work-schedule-input">
                    <input
                      ref={workScheduleInputRef}
                      type="file"
                      id="workScheduleFile"
                      onChange={handleWorkScheduleFilesChange}
                      accept=".pdf,.xlsx,.xls,.jpg,.jpeg,.png"
                      style={{ display: 'none' }}
                      multiple
                    />
                    <button type="button" className="secondary" onClick={handleWorkScheduleButtonClick}>
                      勤務表を選択
                    </button>
                  </div>
                  {formData.workScheduleFiles.length > 0 && (
                    <div style={{ marginTop: '0.5rem' }}>
                      {formData.workScheduleFiles.map((file, index) => (
                        <div key={index} style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.3rem' }}>
                          <span className="file-name" style={{ flex: 1 }}>{file.name}</span>
                          <button
                            type="button"
                            className="secondary"
                            onClick={() => removeWorkScheduleFile(index)}
                            style={{ padding: '0.2rem 0.5rem', fontSize: '0.8rem' }}
                          >
                            削除
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </fieldset>

                {/* 交通費 */}
                <fieldset>
                  <legend>交通費</legend>
                  <div className="commute-table-container">
                    <div className="commute-table-header">
                      <button type="button" className="secondary" onClick={addCommuteEntry}>
                        + 交通費を追加
                      </button>
                    </div>
                    {hasCommuteEntries && (
                      <small>日付・最寄り駅・訪問先駅・金額を入力してください。</small>
                    )}
                    {hasCommuteEntries ? (
                      <div className="commute-cards-grid">
                        {formData.commuteEntries.map((entry, index) => (
                          <div key={`commute-${index}`} className="commute-card">
                            <div className="commute-card-field">
                              <label htmlFor={`commute-date-${index}`} className="commute-card-label">日付</label>
                              <input
                                type="date"
                                id={`commute-date-${index}`}
                                value={entry.date}
                                onChange={(e) => handleCommuteEntryChange(index, 'date', e.target.value)}
                                required
                              />
                            </div>
                            <div className="commute-card-field">
                              <label htmlFor={`commute-origin-${index}`} className="commute-card-label">最寄り駅</label>
                              <input
                                type="text"
                                id={`commute-origin-${index}`}
                                value={entry.origin}
                                onChange={(e) => handleCommuteEntryChange(index, 'origin', e.target.value)}
                                placeholder="例: 渋谷駅"
                                required
                              />
                            </div>
                            <div className="commute-card-field">
                              <label htmlFor={`commute-destination-${index}`} className="commute-card-label">訪問先駅</label>
                              <input
                                type="text"
                                id={`commute-destination-${index}`}
                                value={entry.destination}
                                onChange={(e) => handleCommuteEntryChange(index, 'destination', e.target.value)}
                                placeholder="例: 新宿駅"
                                required
                              />
                            </div>
                            <div className="commute-card-field">
                              <label htmlFor={`commute-tripType-${index}`} className="commute-card-label">区分</label>
                              <select
                                id={`commute-tripType-${index}`}
                                value={entry.tripType}
                                onChange={(e) => handleCommuteEntryChange(index, 'tripType', e.target.value)}
                              >
                                <option value="oneWay">片道</option>
                                <option value="roundTrip">往復</option>
                              </select>
                            </div>
                            <div className="commute-card-field">
                              <label htmlFor={`commute-amount-${index}`} className="commute-card-label">片道の金額</label>
                              <input
                                type="number"
                                min="0"
                                id={`commute-amount-${index}`}
                                value={entry.amount}
                                onChange={(e) => handleCommuteEntryChange(index, 'amount', e.target.value)}
                                placeholder="例: 170"
                                required
                              />
                            </div>
                            <div className="commute-card-actions">
                              <button type="button" className="secondary" onClick={() => duplicateCommuteEntry(index)}>
                                複製
                              </button>
                              <button type="button" className="secondary" onClick={() => removeCommuteEntry(index)}>
                                削除
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <p className="text-muted">「+ 交通費を追加」を押すと入力欄が表示されます。</p>
                    )}
                  </div>
                </fieldset>

                {/* 経費 */}
                <fieldset>
                  <legend>経費</legend>
                  <div className="expense-table-container">
                    <div className="expense-table-header">
                      <button type="button" className="secondary" onClick={addExpenseEntry}>
                        + 経費を追加
                      </button>
                    </div>
                    {hasExpenseEntries && (
                      <small>経費種別を選択し、日付、金額、内容を入力してください。資格受験は領収書に加え、合格通知書の添付が必須です。</small>
                    )}
                    {hasExpenseEntries ? (
                      <div className="expense-cards-grid">
                        {formData.expenseEntries.map((entry, index) => {
                          const category = entry.category || 'other';
                          const isCertification = category === 'certification';
                          return (
                            <div key={`expense-${index}`} className="expense-card">
                              <div className="expense-card-row-3">
                                <div className="expense-card-field">
                                  <label htmlFor={`expense-category-${index}`} className="expense-card-label">経費種別</label>
                                  <select
                                    id={`expense-category-${index}`}
                                    value={category}
                                    onChange={(e) => handleExpenseEntryChange(index, 'category', e.target.value)}
                                  >
                                    <option value="ebook">電子書籍</option>
                                    <option value="udemy">Udemy講座</option>
                                    <option value="seminar">勉強会</option>
                                    <option value="certification">資格受験</option>
                                    <option value="other">その他</option>
                                  </select>
                                </div>
                                <div className="expense-card-field">
                                  <label htmlFor={`expense-date-${index}`} className="expense-card-label">日付</label>
                                  <input
                                    type="date"
                                    id={`expense-date-${index}`}
                                    value={entry.date}
                                    onChange={(e) => handleExpenseEntryChange(index, 'date', e.target.value)}
                                    required
                                  />
                                </div>
                                <div className="expense-card-field">
                                  <label htmlFor={`expense-amount-${index}`} className="expense-card-label">金額（円）</label>
                                  <input
                                    type="number"
                                    min="0"
                                    id={`expense-amount-${index}`}
                                    value={entry.amount}
                                    onChange={(e) => handleExpenseEntryChange(index, 'amount', e.target.value)}
                                    placeholder="例: 1200"
                                    required
                                  />
                                </div>
                              </div>
                              <div className="expense-card-row">
                                <div className="expense-card-field-full">
                                  <label htmlFor={`expense-description-${index}`} className="expense-card-label">内容</label>
                                  <input
                                    type="text"
                                    id={`expense-description-${index}`}
                                    value={entry.description}
                                    onChange={(e) => handleExpenseEntryChange(index, 'description', e.target.value)}
                                    placeholder="例: 備品購入"
                                    required
                                  />
                                </div>
                              </div>
                              <div className="expense-card-row">
                                <div className="expense-card-field">
                                  <span className="expense-card-label">領収書</span>
                                  <div className="work-schedule-input">
                                    <input
                                      type="file"
                                      id={`expense-receipt-${index}`}
                                      accept=".pdf,.xlsx,.xls,.jpg,.jpeg,.png,.heic"
                                      onChange={(e) => handleExpenseReceiptChange(index, e.target.files[0] || null)}
                                      style={{ display: 'none' }}
                                      required
                                    />
                                    <button
                                      type="button"
                                      className="secondary"
                                      onClick={() => document.getElementById(`expense-receipt-${index}`).click()}
                                    >
                                      領収書を選択
                                    </button>
                                    {entry.receiptFile && (
                                      <span className="file-name">{entry.receiptFile.name}</span>
                                    )}
                                  </div>
                                </div>
                                {isCertification && (
                                  <div className="expense-card-field">
                                    <span className="expense-card-label">
                                      合格通知書
                                    </span>
                                    <div className="work-schedule-input">
                                      <input
                                        type="file"
                                        id={`expense-certificate-${index}`}
                                        accept=".pdf,.xlsx,.xls,.jpg,.jpeg,.png,.heic"
                                        onChange={(e) => handleExpenseCertificateChange(index, e.target.files[0] || null)}
                                        style={{ display: 'none' }}
                                        required
                                      />
                                      <button
                                        type="button"
                                        className="secondary"
                                        onClick={() => document.getElementById(`expense-certificate-${index}`).click()}
                                      >
                                        合格通知書を選択
                                      </button>
                                      {entry.certificateFile && (
                                        <span className="file-name">{entry.certificateFile.name}</span>
                                      )}
                                    </div>
                                  </div>
                                )}
                              </div>
                              <div className="expense-card-actions">
                                <button type="button" className="secondary" onClick={() => removeExpenseEntry(index)}>
                                  削除
                                </button>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    ) : (
                      <p className="text-muted">「+ 経費を追加」を押すと入力欄が表示されます。</p>
                    )}
                  </div>
                </fieldset>

                {/* 現場勤務状況 */}
                <fieldset>
                  <legend className="required-label">現場勤務状況</legend>

                  <div className="grid">
                    <label htmlFor="workStartTime">
                      始業時間
                      <input
                        type="time"
                        id="workStartTime"
                        name="workStartTime"
                        value={formData.workStartTime}
                        onChange={handleInputChange}
                        required
                      />
                    </label>

                    <label htmlFor="workEndTime">
                      就業時間
                      <input
                        type="time"
                        id="workEndTime"
                        name="workEndTime"
                        value={formData.workEndTime}
                        onChange={handleInputChange}
                        required
                      />
                    </label>
                  </div>

                  {/* 出社頻度 */}
                  <label htmlFor="officeFrequency">
                    出社頻度
                    <select
                      id="officeFrequency"
                      name="officeFrequency"
                      value={formData.officeFrequency}
                      onChange={handleInputChange}
                      required
                    >
                      <option value="fullRemote">フルリモート</option>
                      <option value="weekly1to2">週1~2出社</option>
                      <option value="weekly3to5">週3~5出社</option>
                    </select>
                  </label>
                </fieldset>

                {/* 定期券購入 */}
                <fieldset>
                  <legend className="required-label">定期券購入</legend>
                  <label>
                    <input
                      type="radio"
                      name="hasCommuterPass"
                      value="yes"
                      checked={formData.hasCommuterPass === 'yes'}
                      onChange={handleInputChange}
                    />
                    有り
                  </label>
                  <label>
                    <input
                      type="radio"
                      name="hasCommuterPass"
                      value="no"
                      checked={formData.hasCommuterPass === 'no'}
                      onChange={handleInputChange}
                    />
                    無し
                  </label>
                </fieldset>

                {/* 定期券詳細（条件付き表示） */}
                {formData.hasCommuterPass === 'yes' && (
                  <fieldset>
                    <legend className="required-label">定期券詳細</legend>

                    <div className="grid">
                      <label htmlFor="nearestStation">
                        最寄り駅
                        <input
                          type="text"
                          id="nearestStation"
                          name="nearestStation"
                          value={formData.nearestStation}
                          onChange={handleInputChange}
                          required={formData.hasCommuterPass === 'yes'}
                          placeholder="例: 渋谷駅"
                        />
                      </label>

                      <label htmlFor="workStation">
                        勤務先の駅
                        <input
                          type="text"
                          id="workStation"
                          name="workStation"
                          value={formData.workStation}
                          onChange={handleInputChange}
                          required={formData.hasCommuterPass === 'yes'}
                          placeholder="例: 新宿駅"
                        />
                      </label>
                    </div>

                    <label htmlFor="monthlyFee">
                      月額（円）
                      <input
                        type="number"
                        id="monthlyFee"
                        name="monthlyFee"
                        value={formData.monthlyFee}
                        onChange={handleInputChange}
                        required={formData.hasCommuterPass === 'yes'}
                        min="0"
                        placeholder="例: 15000"
                      />
                    </label>
                  </fieldset>
                )}

                {/* 備考 */}
                <label htmlFor="remarks">
                  備考
                  <textarea
                    id="remarks"
                    name="remarks"
                    value={formData.remarks}
                    onChange={handleInputChange}
                    rows="4"
                    placeholder="その他連絡事項があればご記入ください"
                  ></textarea>
                </label>

                {/* 送信ボタン */}
                <button type="submit" disabled={submitted}>
                  {submitted ? '送信中...' : '提出する'}
                </button>
              </form>
            </article>
          </main>

          {/* フッター */}
          <footer className="container text-center">
            <p className="mb-0">
              <small>&copy; 2025 Demo Inc. All rights reserved.</small>
            </p>
          </footer>
        </>
      );
    }

    // Reactアプリをマウント
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>

</html>
