<!DOCTYPE html>
<!--
  経費精算フォーム - React版 SPA
-->
<html>

<head>
  <base target="_top" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />

  <!-- React CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    main {
      flex: 1;
    }

    .required-label::after {
      content: " *";
      color: var(--pico-del-color);
    }

    .incident-card {
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }

    .incident-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--pico-card-box-shadow);
    }

    .text-truncate-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .text-truncate-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .text-center {
      text-align: center;
    }

    .mb-0 {
      margin-bottom: 0;
    }

    .mb-2 {
      margin-bottom: 0.5rem;
    }

    .mb-3 {
      margin-bottom: 1rem;
    }

    .py-3 {
      padding-top: 1rem;
      padding-bottom: 1rem;
    }

    .py-5 {
      padding-top: 3rem;
      padding-bottom: 3rem;
    }

    .d-flex {
      display: flex;
    }

    .align-items-center {
      align-items: center;
    }

    .justify-content-center {
      justify-content: center;
    }

    .me-2 {
      margin-right: 0.5rem;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const createEmptyCommuteEntry = () => ({
      date: '',
      origin: '',
      destination: '',
      amount: ''
    });

    const createEmptyExpenseEntry = () => ({
      description: '',
      amount: '',
      receiptFile: null
    });

    function App() {
      const [formData, setFormData] = useState({
        name: '',
        workScheduleFile: null,
        workStartTime: '09:00',
        workEndTime: '18:00',
        hasCommuterPass: 'no',
        nearestStation: '',
        workStation: '',
        monthlyFee: '',
        remarks: '',
        commuteEntries: [createEmptyCommuteEntry()],
        expenseEntries: [createEmptyExpenseEntry()]
      });

      const [submitted, setSubmitted] = useState(false);
      const formRef = useRef(null);

      const handleInputChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({
          ...prev,
          [name]: value
        }));
      };

      const handleFileChange = (e) => {
        const { name, files } = e.target;
        setFormData(prev => ({
          ...prev,
          [name]: files[0] || null
        }));
      };

      const handleCommuteEntryChange = (index, field, value) => {
        setFormData(prev => {
          const updated = prev.commuteEntries.map((entry, idx) =>
            idx === index ? { ...entry, [field]: value } : entry
          );
          return { ...prev, commuteEntries: updated };
        });
      };

      const addCommuteEntry = () => {
        setFormData(prev => ({
          ...prev,
          commuteEntries: [...prev.commuteEntries, createEmptyCommuteEntry()]
        }));
      };

      const removeCommuteEntry = (index) => {
        setFormData(prev => {
          if (prev.commuteEntries.length === 1) {
            return prev;
          }
          const updated = prev.commuteEntries.filter((_, idx) => idx !== index);
          return { ...prev, commuteEntries: updated };
        });
      };

      const handleExpenseEntryChange = (index, field, value) => {
        setFormData(prev => {
          const updated = prev.expenseEntries.map((entry, idx) => {
            if (idx !== index) return entry;
            const nextEntry = { ...entry, [field]: value };
            if (!nextEntry.description && !nextEntry.amount) {
              nextEntry.receiptFile = null;
            }
            return nextEntry;
          });
          return { ...prev, expenseEntries: updated };
        });
      };

      const handleExpenseReceiptChange = (index, file) => {
        setFormData(prev => {
          const updated = prev.expenseEntries.map((entry, idx) =>
            idx === index ? { ...entry, receiptFile: file } : entry
          );
          return { ...prev, expenseEntries: updated };
        });
      };

      const addExpenseEntry = () => {
        setFormData(prev => ({
          ...prev,
          expenseEntries: [...prev.expenseEntries, createEmptyExpenseEntry()]
        }));
      };

      const removeExpenseEntry = (index) => {
        setFormData(prev => {
          if (prev.expenseEntries.length === 1) {
            return prev;
          }
          const updated = prev.expenseEntries.filter((_, idx) => idx !== index);
          return { ...prev, expenseEntries: updated };
        });
      };

      const collectCommuteEntries = () => {
        const entries = [];

        for (const entry of formData.commuteEntries) {
          const hasValue =
            entry.date || entry.origin || entry.destination || entry.amount;
          if (!hasValue) {
            continue;
          }

          const isComplete =
            entry.date && entry.origin && entry.destination && entry.amount;
          if (!isComplete) {
            throw new Error('交通費の各項目（日時・最寄り駅・訪問先駅・金額）を入力してください。');
          }

          entries.push({ ...entry });
        }

        return entries;
      };

      const collectExpenseEntries = async () => {
        const entries = [];

        for (const entry of formData.expenseEntries) {
          const hasValue = entry.description || entry.amount;
          if (!hasValue) {
            continue;
          }

          if (!entry.description || !entry.amount) {
            throw new Error('経費の内容と金額を入力してください。');
          }

          if (!entry.receiptFile) {
            throw new Error('経費には領収書の添付が必須です。');
          }

          const receiptFileData = await encodeFileToBase64(entry.receiptFile);

          if (!receiptFileData) {
            throw new Error('領収書の変換に失敗しました。');
          }

          entries.push({
            description: entry.description,
            amount: entry.amount,
            receiptFile: receiptFileData
          });
        }

        return entries;
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setSubmitted(true);

        try {
          // ファイルをBase64エンコード
          const workScheduleFileData = await encodeFileToBase64(formData.workScheduleFile);
          const commuteEntries = collectCommuteEntries();
          const expenseEntries = await collectExpenseEntries();

          // バックエンドに送信するデータを準備
          const expenseData = {
            name: formData.name,
            workScheduleFile: workScheduleFileData,
            workStartTime: formData.workStartTime,
            workEndTime: formData.workEndTime,
            hasCommuterPass: formData.hasCommuterPass,
            nearestStation: formData.nearestStation,
            workStation: formData.workStation,
            monthlyFee: formData.monthlyFee,
            remarks: formData.remarks,
            commuteEntries,
            expenseEntries
          };

          // Google Apps Scriptのバックエンド関数を呼び出し
          google.script.run
            .withSuccessHandler((result) => {
              alert(result.message);
              // フォームをリセット
              if (formRef.current) {
                formRef.current.reset();
              }
              setFormData({
                name: '',
                workScheduleFile: null,
                workStartTime: '09:00',
                workEndTime: '18:00',
                hasCommuterPass: 'no',
                nearestStation: '',
                workStation: '',
                monthlyFee: '',
                remarks: '',
                commuteEntries: [createEmptyCommuteEntry()],
                expenseEntries: [createEmptyExpenseEntry()]
              });
              setSubmitted(false);
            })
            .withFailureHandler((error) => {
              alert('エラーが発生しました: ' + error.message);
              setSubmitted(false);
            })
            .submitExpense(expenseData);
        } catch (error) {
          alert('エラーが発生しました: ' + error.message);
          setSubmitted(false);
        }
      };

      const encodeFileToBase64 = (file) => {
        return new Promise((resolve, reject) => {
          if (!file) {
            resolve(null);
            return;
          }

          const reader = new FileReader();
          reader.onload = () => {
            const base64 = reader.result.split(',')[1];
            resolve({
              name: file.name,
              mimeType: file.type,
              data: base64
            });
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      };

      return (
        <>
          <main className="container">
            {/* ヘッダー */}
            <article className="text-center py-3">
              <div className="d-flex align-items-center justify-content-center mb-2">
                <i className="bi bi-receipt me-2" style={{ fontSize: '2rem', color: 'var(--pico-primary)' }}></i>
                <h1 className="mb-0">経費精算フォーム</h1>
              </div>
              <p className="mb-0">
                経費精算に必要な情報を入力してください
              </p>
            </article>

            {/* フォーム */}
            <article>
              <form ref={formRef} onSubmit={handleSubmit}>
                {/* 氏名 */}
                <legend className="required-label">氏名</legend>
                <label htmlFor="name">
                  <input
                    type="text"
                    id="name"
                    name="name"
                    value={formData.name}
                    onChange={handleInputChange}
                    required
                    placeholder="山田 太郎"
                  />
                </label>

                {/* 提出物 */}
                <fieldset>
                  <legend className="required-label">提出物</legend>

                  <label htmlFor="workScheduleFile">
                    勤務表
                    <input
                      type="file"
                      id="workScheduleFile"
                      name="workScheduleFile"
                      onChange={handleFileChange}
                      accept=".pdf,.xlsx,.xls,.jpg,.jpeg,.png"
                    />
                  </label>
                </fieldset>

                {/* 交通費 */}
                <fieldset>
                  <legend>交通費</legend>
                  <small>日付・最寄り駅・訪問先駅・金額を入力してください。</small>
                  {formData.commuteEntries.map((entry, index) => (
                    <article key={`commute-${index}`}>
                      <div className="grid">
                        <label htmlFor={`commute-date-${index}`}>
                          日付
                          <input
                            type="date"
                            id={`commute-date-${index}`}
                            value={entry.date}
                            onChange={(e) => handleCommuteEntryChange(index, 'date', e.target.value)}
                          />
                        </label>
                        <label htmlFor={`commute-origin-${index}`}>
                          最寄り駅
                          <input
                            type="text"
                            id={`commute-origin-${index}`}
                            value={entry.origin}
                            onChange={(e) => handleCommuteEntryChange(index, 'origin', e.target.value)}
                            placeholder="例: 渋谷"
                          />
                        </label>
                      </div>
                      <div className="grid">
                        <label htmlFor={`commute-destination-${index}`}>
                          訪問先駅
                          <input
                            type="text"
                            id={`commute-destination-${index}`}
                            value={entry.destination}
                            onChange={(e) => handleCommuteEntryChange(index, 'destination', e.target.value)}
                            placeholder="例: 新宿"
                          />
                        </label>
                        <label htmlFor={`commute-amount-${index}`}>
                          金額（円）
                          <input
                            type="number"
                            min="0"
                            id={`commute-amount-${index}`}
                            value={entry.amount}
                            onChange={(e) => handleCommuteEntryChange(index, 'amount', e.target.value)}
                            placeholder="例: 420"
                          />
                        </label>
                      </div>
                      {formData.commuteEntries.length > 1 && (
                        <button type="button" className="secondary" onClick={() => removeCommuteEntry(index)}>
                          削除
                        </button>
                      )}
                    </article>
                  ))}
                  <button type="button" className="secondary" onClick={addCommuteEntry}>
                    + 交通費を追加
                  </button>
                </fieldset>

                {/* 経費 */}
                <fieldset>
                  <legend>経費</legend>
                  <small>内容と金額を入力すると領収書の添付欄が表示されます（必須）。</small>
                  {formData.expenseEntries.map((entry, index) => {
                    const isActive = Boolean(entry.description || entry.amount);
                    return (
                      <article key={`expense-${index}`}>
                        <label htmlFor={`expense-description-${index}`}>
                          内容
                          <input
                            type="text"
                            id={`expense-description-${index}`}
                            value={entry.description}
                            onChange={(e) => handleExpenseEntryChange(index, 'description', e.target.value)}
                            placeholder="例: 備品購入"
                          />
                        </label>
                        <label htmlFor={`expense-amount-${index}`}>
                          金額（円）
                          <input
                            type="number"
                            min="0"
                            id={`expense-amount-${index}`}
                            value={entry.amount}
                            onChange={(e) => handleExpenseEntryChange(index, 'amount', e.target.value)}
                            placeholder="例: 1200"
                          />
                        </label>
                        {isActive && (
                          <>
                            <legend className="required-label">領収書（必須）</legend>
                            <label htmlFor={`expense-receipt-${index}`}>
                              <input
                                type="file"
                                id={`expense-receipt-${index}`}
                                accept=".pdf,.xlsx,.xls,.jpg,.jpeg,.png,.heic"
                                onChange={(e) => handleExpenseReceiptChange(index, e.target.files[0] || null)}
                                required
                              />
                            </label>
                          </>
                        )}
                        {formData.expenseEntries.length > 1 && (
                          <button type="button" className="secondary" onClick={() => removeExpenseEntry(index)}>
                            削除
                          </button>
                        )}
                      </article>
                    );
                  })}
                  <button type="button" className="secondary" onClick={addExpenseEntry}>
                    + 経費を追加
                  </button>
                </fieldset>

                {/* 現場の定時 */}
                <fieldset>
                  <legend className="required-label">現場の定時</legend>
                  <div className="grid">
                    <label htmlFor="workStartTime">
                      開始
                      <input
                        type="time"
                        id="workStartTime"
                        name="workStartTime"
                        value={formData.workStartTime}
                        onChange={handleInputChange}
                        required
                      />
                    </label>

                    <label htmlFor="workEndTime">
                      終了
                      <input
                        type="time"
                        id="workEndTime"
                        name="workEndTime"
                        value={formData.workEndTime}
                        onChange={handleInputChange}
                        required
                      />
                    </label>
                  </div>
                </fieldset>

                {/* 定期券購入 */}
                <fieldset>
                  <legend className="required-label">定期券購入</legend>
                  <label>
                    <input
                      type="radio"
                      name="hasCommuterPass"
                      value="yes"
                      checked={formData.hasCommuterPass === 'yes'}
                      onChange={handleInputChange}
                    />
                    有り
                  </label>
                  <label>
                    <input
                      type="radio"
                      name="hasCommuterPass"
                      value="no"
                      checked={formData.hasCommuterPass === 'no'}
                      onChange={handleInputChange}
                    />
                    無し
                  </label>
                </fieldset>

                {/* 定期券詳細（条件付き表示） */}
                {formData.hasCommuterPass === 'yes' && (
                  <fieldset>
                    <legend>定期券詳細</legend>

                    <label htmlFor="nearestStation">
                      最寄り駅
                      <input
                        type="text"
                        id="nearestStation"
                        name="nearestStation"
                        value={formData.nearestStation}
                        onChange={handleInputChange}
                        required={formData.hasCommuterPass === 'yes'}
                        placeholder="例: 渋谷駅"
                      />
                    </label>

                    <label htmlFor="workStation">
                      勤務先の駅
                      <input
                        type="text"
                        id="workStation"
                        name="workStation"
                        value={formData.workStation}
                        onChange={handleInputChange}
                        required={formData.hasCommuterPass === 'yes'}
                        placeholder="例: 新宿駅"
                      />
                    </label>

                    <label htmlFor="monthlyFee">
                      月額（円）
                      <input
                        type="number"
                        id="monthlyFee"
                        name="monthlyFee"
                        value={formData.monthlyFee}
                        onChange={handleInputChange}
                        required={formData.hasCommuterPass === 'yes'}
                        min="0"
                        placeholder="例: 15000"
                      />
                    </label>
                  </fieldset>
                )}

                {/* 備考 */}
                <label htmlFor="remarks">
                  備考
                  <textarea
                    id="remarks"
                    name="remarks"
                    value={formData.remarks}
                    onChange={handleInputChange}
                    rows="4"
                    placeholder="その他連絡事項があればご記入ください"
                  ></textarea>
                </label>

                {/* 送信ボタン */}
                <button type="submit" disabled={submitted}>
                  {submitted ? '送信中...' : '提出する'}
                </button>
              </form>
            </article>
          </main>

          {/* フッター */}
          <footer className="container text-center">
            <p className="mb-0">
              <small>&copy; 2025 Demo Inc. All rights reserved.</small>
            </p>
          </footer>
        </>
      );
    }

    // Reactアプリをマウント
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>

</html>
