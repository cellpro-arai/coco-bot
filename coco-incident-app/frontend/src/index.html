<!doctype html>
<html>
  <head>
    <base target="_top" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <script type="module" src="/app.ts"></script>
  </head>

  <body>
    <div id="app-wrapper" x-data="incidentApp()" x-init="init()">
      <!-- ヘッダー -->
      <header class="container py-3">
        <div class="header-theme-button">
          <button @click="toggleTheme()" class="contrast">
            <i
              class="bi"
              :class="theme === 'light' ? 'bi-moon-fill' : 'bi-sun-fill'"
            ></i>
          </button>
        </div>
        <div class="d-flex align-items-center mb-2">
          <h1 class="mb-0">【セルプロ】インシデント管理システム</h1>
        </div>
        <p class="mb-0">
          トラブル情報を詳細に記録し、適切な対応を行うための管理システムです
        </p>
      </header>

      <main class="container">
        <!-- 一覧画面 -->
        <div x-show="currentView === 'list'">
          <!-- ツールバー -->
          <nav class="container-fluid">
            <ul>
              <li>
                <hgroup>
                  <h2 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>インシデント一覧
                  </h2>
                </hgroup>
              </li>
            </ul>
            <ul>
              <li>
                <button
                  class="secondary"
                  @click="loadIncidents()"
                  :disabled="loading"
                >
                  <i class="bi bi-arrow-clockwise me-2"></i>更新
                </button>
              </li>
              <li>
                <button @click="showForm()">
                  <i class="bi bi-plus-circle me-2"></i>新規起票
                </button>
              </li>
            </ul>
          </nav>

          <!-- ローディング -->
          <template x-if="loading">
            <article class="text-center py-5" aria-busy="true">
              <p>データを読み込んでいます...</p>
            </article>
          </template>

          <!-- エラー表示 -->
          <template x-if="error && !loading">
            <article class="danger">
              <i class="bi bi-exclamation-circle-fill me-2"></i>
              <span x-text="error"></span>
            </article>
          </template>

          <!-- カード一覧 -->
          <template x-if="!loading && !error">
            <div>
              <template x-if="incidents.length === 0">
                <article class="info text-center">
                  <i class="bi bi-info-circle me-2"></i>
                  インシデントはまだ登録されていません
                </article>
              </template>

              <div class="grid">
                <template
                  x-for="incident in incidents"
                  :key="incident.registeredDate"
                >
                  <div class="col">
                    <article @click="editIncident(incident)">
                      <div class="card-header">
                        <h5 x-text="incident.caseName"></h5>
                        <template x-if="incident.updateDate">
                          <small class="update-date">
                            <i class="bi bi-clock-fill"></i>
                            <span x-text="incident.updateDate"></span>
                          </small>
                        </template>
                      </div>
                      <div class="mb-2">
                        <span class="badge primary me-2">
                          <i class="bi bi-person-fill me-1"></i>
                          <span x-text="incident.assignee"></span>
                        </span>
                        <span
                          class="badge me-2"
                          :class="{
                        'warning': incident.status === '対応中',
                        'secondary': incident.status === '保留',
                        'success': incident.status === '解決済み',
                        'contrast': incident.status === 'クローズ'
                      }"
                        >
                          <i class="bi bi-flag-fill me-1"></i>
                          <span x-text="incident.status"></span>
                        </span>
                      </div>
                      <p
                        class="text-truncate-2 mb-2"
                        x-text="incident.summary"
                      ></p>
                    </article>
                  </div>
                </template>
              </div>
            </div>
          </template>
        </div>

        <!-- 入力フォーム画面 -->
        <div x-show="currentView === 'form'">
          <!-- 戻るボタン -->
          <button class="secondary" @click="backToList()">
            <i class="bi bi-arrow-left"></i>
            一覧へ戻る
          </button>

          <!-- フォームカード -->
          <article class="p-4">
            <!-- エラー表示 -->
            <template x-if="error">
              <article
                class="danger d-flex align-items-center mb-4"
                role="alert"
              >
                <i class="bi bi-exclamation-circle-fill me-2"></i>
                <span x-text="error"></span>
              </article>
            </template>

            <!-- 重要な注意事項 -->
            <article class="warning mb-4" role="alert">
              <h6 class="d-flex align-items-center mb-3">
                <i class="bi bi-info-circle-fill me-2"></i>
                重要な注意事項
              </h6>
              <ul class="mb-0">
                <li>すべての情報をできるだけ詳細に記入してください</li>
                <li>些細な情報でも省略せず、すべて記載してください</li>
                <li>情報の加工や省略は行わないでください</li>
                <li>わかる範囲ですべての関係者を記載してください</li>
              </ul>
            </article>

            <!-- AI解析待ち表示（編集モード時のみ） -->
            <template
              x-if="formData.registeredDate && selectedIncident && selectedIncident.aiAnalysisStatus === AI_ANALYSIS_STATUS.PENDING"
            >
              <article class="warning mb-4">
                <header>
                  <h6 class="mb-0">
                    <i class="bi bi-hourglass-split me-2"></i>
                    AI解析待ち
                  </h6>
                </header>
                <div>
                  <p class="mb-2">
                    このインシデントはAI解析がまだ完了していません。
                  </p>
                  <p class="mb-3">
                    詳細スプレッドシートを開いて、セルB5のAI数式を手動で更新してください。
                  </p>
                  <a
                    :href="selectedIncident.incidentDetailUrl"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="contrast"
                  >
                    <i class="bi bi-box-arrow-up-right me-1"></i>
                    詳細スプレッドシートを開く
                  </a>
                </div>
              </article>
            </template>

            <!-- AI解析結果表示（編集モード時のみ） -->
            <template
              x-if="formData.registeredDate && selectedIncident && selectedIncident.aiAnalysisStatus === AI_ANALYSIS_STATUS.COMPLETED && selectedIncident.aiAnalysis"
            >
              <article class="info mb-4">
                <header>
                  <h6 class="mb-0">
                    <i class="bi bi-robot me-2"></i>
                    AI解析結果
                  </h6>
                </header>
                <div>
                  <div
                    class="text-pre-wrap"
                    x-text="selectedIncident.aiAnalysis"
                  ></div>
                </div>
              </article>
            </template>

            <!-- フォーム -->
            <form @submit.prevent="submitForm">
              <div class="grid">
                <!-- 案件名 -->
                <label for="caseName">
                  <span class="required-label">
                    <i class="bi bi-folder-fill text-primary me-1"></i>
                    案件名
                  </span>
                  <input
                    type="text"
                    id="caseName"
                    x-model="formData.caseName"
                    required
                    placeholder="例: 〇〇システム障害"
                  />
                  <small>案件を識別できる名前を記入してください</small>
                </label>
                <!-- 担当者 -->
                <label for="assignee">
                  <span class="required-label">
                    <i class="bi bi-person-fill text-primary me-1"></i>
                    担当者
                  </span>
                  <input
                    type="text"
                    id="assignee"
                    x-model="formData.assignee"
                    required
                    placeholder="例: 山田太郎"
                  />
                  <small
                    >このインシデントを担当する方の名前を1名記入してください</small
                  >
                </label>
              </div>

              <div class="grid">
                <!-- ステータス -->
                <label for="status">
                  <span class="required-label">
                    <i class="bi bi-flag-fill text-primary me-1"></i>
                    ステータス
                  </span>
                  <select id="status" x-model="formData.status" required>
                    <option value="対応中">対応中</option>
                    <option value="保留">保留</option>
                    <option value="解決済み">解決済み</option>
                    <option value="クローズ">クローズ</option>
                  </select>
                  <small>現在の対応状況を選択してください</small>
                </label>

                <!-- トラブル概要 -->
                <label for="summary">
                  <span class="required-label">
                    <i class="bi bi-card-text text-primary me-1"></i>
                    トラブル概要
                  </span>
                  <textarea
                    id="summary"
                    x-model="formData.summary"
                    rows="3"
                    required
                    placeholder="例: サーバーがダウンし、サービスにアクセスできない状態が発生しました"
                  ></textarea>
                  <small>トラブルの概要を簡潔に記入してください</small>
                </label>
              </div>

              <!-- ステークホルダー -->
              <label for="stakeholders">
                <span class="required-label">
                  <i class="bi bi-people-fill text-primary me-1"></i>
                  ステークホルダー
                </span>
                <textarea
                  id="stakeholders"
                  x-model="formData.stakeholders"
                  rows="5"
                  required
                  placeholder="例:
- 顧客: 株式会社ABC 田中様
- 社内: 開発部 鈴木課長、営業部 佐藤係長
- ベンダー: XYZ社 高橋様"
                ></textarea>
                <small>
                  <strong>関係するすべての人物を記載してください：</strong>
                  <ul class="mb-0 mt-1">
                    <li>顧客・クライアント</li>
                    <li>社内関係者（上司、同僚、他部署など）</li>
                    <li>外部ベンダー・協力会社</li>
                    <li>その他関係者</li>
                  </ul>
                  些細な関わりでも、名前がわかる人は全員記載してください
                </small>
              </label>

              <!-- トラブル詳細 -->
              <label for="details">
                <span class="required-label">
                  <i class="bi bi-file-text-fill text-primary me-1"></i>
                  トラブル詳細
                </span>
                <textarea
                  id="details"
                  x-model="formData.details"
                  rows="10"
                  required
                  placeholder="例:
【発生日時】2025年1月15日 14:30頃
【発覚の経緯】顧客からの問い合わせ

【現象】
- サービスページにアクセスすると503エラーが表示される
- 管理画面も同様にアクセス不可

【影響範囲】全ユーザー（約1000名）

【対応状況】
14:35 - インフラチームに連絡、調査開始
14:50 - サーバー再起動を実施、復旧せず
15:10 - ログを確認、メモリ不足が原因と判明

【その他】
- 前日にデータベースの大量更新を実施していた
- 同様の事象は過去にも一度発生（2024年12月）"
                ></textarea>
                <small>
                  <strong
                    >以下の情報をできるだけ詳しく記載してください：</strong
                  >
                  <ul class="mb-0 mt-1">
                    <li>発生日時・発覚の経緯</li>
                    <li>具体的な現象・症状</li>
                    <li>影響範囲（ユーザー数、システム範囲など）</li>
                    <li>対応状況・時系列</li>
                    <li>原因と思われる事項</li>
                    <li>過去の類似事例</li>
                    <li>その他気づいた点すべて</li>
                  </ul>
                </small>
              </label>

              <hr />

              <!-- 既存の添付ファイル（編集モード時） -->
              <template
                x-if="formData.registeredDate && selectedIncident && selectedIncident.attachments && selectedIncident.attachments.trim()"
              >
                <div class="mb-3">
                  <label>
                    <i class="bi bi-paperclip me-1"></i>
                    既存の添付ファイル
                  </label>
                  <article class="info">
                    <div
                      class="small text-pre-wrap"
                      x-text="selectedIncident.attachments"
                    ></div>
                    <template x-if="selectedIncident.driveFolderUrl">
                      <div class="mt-2">
                        <a
                          :href="selectedIncident.driveFolderUrl"
                          target="_blank"
                          rel="noopener noreferrer"
                        >
                          <i class="bi bi-folder2-open me-1"></i>
                          Driveフォルダを開く
                        </a>
                      </div>
                    </template>
                  </article>
                </div>
              </template>

              <!-- 関連ファイル -->
              <label for="fileUpload">
                <i class="bi bi-cloud-upload me-1"></i>
                <span
                  x-text="formData.registeredDate ? '追加ファイルのアップロード' : '関連ファイルのアップロード'"
                ></span>
                <input
                  type="file"
                  id="fileUpload"
                  @change="handleFileUpload"
                  multiple
                />
                <small
                  x-text="formData.registeredDate ? '新しくファイルを追加する場合は選択してください（複数選択可能）' : 'メールのやり取り、契約書類、スクリーンショット、動画などをアップロードできます（複数選択可能）'"
                ></small>
              </label>
              <!-- 選択されたファイルリスト -->
              <template
                x-if="formData.fileDataList && formData.fileDataList.length > 0"
              >
                <div class="mt-2">
                  <small class="text-muted mb-1">選択されたファイル:</small>
                  <ul>
                    <template
                      x-for="(file, index) in formData.fileDataList"
                      :key="index"
                    >
                      <li>
                        <span class="small" x-text="file.name"></span>
                        <button
                          type="button"
                          class="contrast outline"
                          @click="removeFile(index)"
                        >
                          <i class="bi bi-x"></i>
                        </button>
                      </li>
                    </template>
                  </ul>
                </div>
              </template>

              <hr />

              <!-- 送信ボタン -->
              <button type="submit" :disabled="submitting">
                <span x-show="!submitting">
                  <i class="bi bi-check-circle-fill me-2"></i>
                  <span
                    x-text="formData.registeredDate ? '更新する' : '登録する'"
                  ></span>
                </span>
                <span x-show="submitting">
                  <span class="bi bi-arrow-clockwise me-2"></span>
                  <span
                    x-text="formData.registeredDate ? '更新中...' : '送信中...'"
                  ></span>
                </span>
              </button>
            </form>
          </article>
        </div>
      </main>

      <!-- 送信成功モーダル -->
      <template x-if="showSuccessModal && submittedIncident">
        <dialog :open="showSuccessModal">
          <article>
            <header>
              <a
                @click.prevent="closeSuccessModal()"
                href="#"
                aria-label="Close"
                class="close"
              ></a>
              <hgroup>
                <h3 class="mb-2">
                  <i class="bi bi-check-circle-fill me-2"></i>
                  <span
                    x-text="'インシデント情報の' + (submittedIncident.updateDate !== submittedIncident.registeredDate ? '更新': '登録') + 'が完了しました！'"
                  ></span>
                </h3>
                <p>以下の内容で処理されました。</p>
              </hgroup>
            </header>

            <!-- AI改善案の生成（手動） -->
            <article class="warning mb-4">
              <header class="mb-2">
                <h6 class="mb-0">
                  <i class="bi bi-lightbulb-fill me-2"></i>
                  AI改善案を生成しましょう
                </h6>
              </header>

              <p class="mb-3">
                AIによる改善案を生成するには、手動での更新が必要です。<br />
                スプレッドシートを開き、改善案の数式セル（B5）を再計算してください。
              </p>

              <a
                :href="submittedIncident.incidentDetailUrl"
                target="_blank"
                rel="noopener noreferrer"
                class="contrast"
                role="button"
              >
                <i class="bi bi-box-arrow-up-right me-1"></i>
                詳細スプレッドシートを開く
              </a>
            </article>

            <footer>
              <button class="autowidth" @click="closeSuccessModal()">
                <i class="bi bi-arrow-left me-2"></i>
                一覧へ戻る
              </button>
            </footer>
          </article>
        </dialog>
      </template>

      <!-- フッター -->
      <footer class="container">
        <small
          >&copy; 2025 Cell Promote Inc. (Coco Incident). All rights
          reserved.</small
        >
      </footer>
    </div>

    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
  </body>
</html>
