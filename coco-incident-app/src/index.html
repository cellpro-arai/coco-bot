<!DOCTYPE html>
<!--
  インシデント管理システム - Alpine.js版 SPA

  【Alpine.jsの主な機能】
  - x-data: コンポーネントの状態管理
  - x-init: 初期化処理
  - x-show: 条件付き表示
  - x-model: 双方向データバインディング
  - @submit.prevent: イベントハンドラ
  - x-text: テキスト表示

  【画面構成】
  - 一覧画面: インシデントをカード形式で表示
  - 入力画面: インシデント起票・編集フォーム
-->
<html>

<head>
  <base target="_top" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .main-container {
      flex: 1;
    }

    .required-label::after {
      content: " *";
      color: #dc3545;
    }

    .incident-card {
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }

    .incident-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .text-truncate-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .text-truncate-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>

<body>
  <div class="main-container container py-4" style="max-width: 1200px" x-data="incidentApp()" x-init="init()">
    <!-- ヘッダー -->
    <div class="card shadow-sm mb-4">
      <div class="card-body text-center py-3">
        <div class="mb-2">
          <i class="bi bi-exclamation-triangle-fill text-primary" style="font-size: 2rem"></i>
        </div>
        <h1 class="h4 mb-1">インシデント管理システム</h1>
        <p class="text-muted small mb-0">
          トラブル情報を詳細に記録し、適切な対応を行うための管理システムです
        </p>
      </div>
    </div>

    <!-- 一覧画面 -->
    <div x-show="currentView === 'list'">
      <!-- ツールバー -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h4 mb-0">
          <i class="bi bi-list-ul me-2"></i>
          インシデント一覧
        </h2>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary" @click="loadIncidents()" :disabled="loading">
            <i class="bi bi-arrow-clockwise me-2"></i>
            更新
          </button>
          <button class="btn btn-primary" @click="showForm()">
            <i class="bi bi-plus-circle me-2"></i>
            新規起票
          </button>
        </div>
      </div>

      <!-- ローディング -->
      <template x-if="loading">
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">読み込み中...</span>
          </div>
          <p class="mt-3 text-muted">データを読み込んでいます...</p>
        </div>
      </template>

      <!-- エラー表示 -->
      <template x-if="error && !loading">
        <div class="alert alert-danger d-flex align-items-center" role="alert">
          <i class="bi bi-exclamation-circle-fill me-2"></i>
          <span x-text="error"></span>
        </div>
      </template>

      <!-- カード一覧 -->
      <template x-if="!loading && !error">
        <div>
          <template x-if="incidents.length === 0">
            <div class="alert alert-info text-center">
              <i class="bi bi-info-circle me-2"></i>
              インシデントはまだ登録されていません
            </div>
          </template>

          <div class="row g-3">
            <template x-for="incident in incidents" :key="incident.registeredDate">
              <div class="col-12">
                <div class="card incident-card shadow-sm" @click="editIncident(incident)">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <h5 class="card-title mb-0" x-text="incident.caseName"></h5>
                      <span class="badge bg-secondary" x-text="incident.registeredDate"></span>
                    </div>
                    <div class="mb-2">
                      <span class="badge bg-primary me-2">
                        <i class="bi bi-person-fill me-1"></i>
                        <span x-text="incident.assignee"></span>
                      </span>
                      <span class="badge bg-info text-dark">
                        <i class="bi bi-envelope-fill me-1"></i>
                        <span x-text="incident.registeredUser"></span>
                      </span>
                    </div>
                    <p class="card-text text-truncate-2 mb-2" x-text="incident.summary"></p>
                    <div class="small text-muted">
                      <div class="text-truncate-3" x-text="incident.details"></div>
                    </div>
                    <template x-if="incident.attachments">
                      <div class="mt-2">
                        <span class="badge bg-success">
                          <i class="bi bi-paperclip me-1"></i>
                          添付ファイルあり
                        </span>
                      </div>
                    </template>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>
      </template>
    </div>

    <!-- 入力フォーム画面 -->
    <div x-show="currentView === 'form'">
      <!-- 戻るボタン -->
      <div class="mb-3">
        <button class="btn btn-outline-secondary" @click="backToList()">
          <i class="bi bi-arrow-left me-2"></i>
          一覧へ戻る
        </button>
      </div>

      <!-- フォームカード -->
      <div class="card shadow-sm">
        <div class="card-body p-4">
          <!-- エラー表示 -->
          <template x-if="error">
            <div class="alert alert-danger d-flex align-items-center mb-4" role="alert">
              <i class="bi bi-exclamation-circle-fill me-2"></i>
              <span x-text="error"></span>
            </div>
          </template>

          <!-- 重要な注意事項 -->
          <div class="alert alert-warning mb-4" role="alert">
            <h6 class="alert-heading d-flex align-items-center mb-3">
              <i class="bi bi-info-circle-fill me-2"></i>
              重要な注意事項
            </h6>
            <ul class="mb-0">
              <li>すべての情報をできるだけ詳細に記入してください</li>
              <li>些細な情報でも省略せず、すべて記載してください</li>
              <li>情報の加工や省略は行わないでください</li>
              <li>わかる範囲ですべての関係者を記載してください</li>
            </ul>
          </div>

          <!-- フォーム -->
          <form @submit.prevent="submitIncident">
            <!-- 案件名 -->
            <div class="mb-4">
              <label for="caseName" class="form-label fw-semibold required-label">
                <i class="bi bi-folder-fill text-primary me-1"></i>
                案件名
              </label>
              <input type="text" class="form-control" id="caseName" x-model="formData.caseName" required
                placeholder="例: 〇〇システム障害" />
              <div class="form-text">
                案件を識別できる名前を記入してください
              </div>
            </div>

            <!-- 担当者 -->
            <div class="mb-4">
              <label for="assignee" class="form-label fw-semibold required-label">
                <i class="bi bi-person-fill text-primary me-1"></i>
                担当者
              </label>
              <input type="text" class="form-control" id="assignee" x-model="formData.assignee" required
                placeholder="例: 山田太郎" />
              <div class="form-text">
                このインシデントを担当する方の名前を1名記入してください
              </div>
            </div>

            <!-- トラブル概要 -->
            <div class="mb-4">
              <label for="summary" class="form-label fw-semibold required-label">
                <i class="bi bi-card-text text-primary me-1"></i>
                トラブル概要
              </label>
              <textarea class="form-control" id="summary" x-model="formData.summary" rows="3" required
                placeholder="例: サーバーがダウンし、サービスにアクセスできない状態が発生しました"></textarea>
              <div class="form-text">
                トラブルの概要を簡潔に記入してください
              </div>
            </div>

            <!-- ステークホルダー -->
            <div class="mb-4">
              <label for="stakeholders" class="form-label fw-semibold required-label">
                <i class="bi bi-people-fill text-primary me-1"></i>
                ステークホルダー
              </label>
              <textarea class="form-control" id="stakeholders" x-model="formData.stakeholders" rows="5" required
                placeholder="例:
- 顧客: 株式会社ABC 田中様
- 社内: 開発部 鈴木課長、営業部 佐藤係長
- ベンダー: XYZ社 高橋様"></textarea>
              <div class="form-text">
                <strong>関係するすべての人物を記載してください：</strong>
                <ul class="small mb-0 mt-1">
                  <li>顧客・クライアント</li>
                  <li>社内関係者（上司、同僚、他部署など）</li>
                  <li>外部ベンダー・協力会社</li>
                  <li>その他関係者</li>
                </ul>
                些細な関わりでも、名前がわかる人は全員記載してください
              </div>
            </div>

            <!-- トラブル詳細 -->
            <div class="mb-4">
              <label for="details" class="form-label fw-semibold required-label">
                <i class="bi bi-file-text-fill text-primary me-1"></i>
                トラブル詳細
              </label>
              <textarea class="form-control" id="details" x-model="formData.details" rows="10" required placeholder="例:
【発生日時】2025年1月15日 14:30頃
【発覚の経緯】顧客からの問い合わせ
【現象】
- サービスページにアクセスすると503エラーが表示される
- 管理画面も同様にアクセス不可
【影響範囲】全ユーザー（約1000名）
【対応状況】
14:35 - インフラチームに連絡、調査開始
14:50 - サーバー再起動を実施、復旧せず
15:10 - ログを確認、メモリ不足が原因と判明
【その他】
- 前日にデータベースの大量更新を実施していた
- 同様の事象は過去にも一度発生（2024年12月）"></textarea>
              <div class="form-text">
                <strong>以下の情報をできるだけ詳しく記載してください：</strong>
                <ul class="small mb-0 mt-1">
                  <li>発生日時・発覚の経緯</li>
                  <li>具体的な現象・症状</li>
                  <li>影響範囲（ユーザー数、システム範囲など）</li>
                  <li>対応状況・時系列</li>
                  <li>原因と思われる事項</li>
                  <li>過去の類似事例</li>
                  <li>その他気づいた点すべて</li>
                </ul>
              </div>
            </div>

            <hr class="my-4" />

            <!-- 関連ファイル -->
            <div class="mb-4">
              <label for="fileUpload" class="form-label fw-semibold">
                <i class="bi bi-cloud-upload me-1"></i>
                関連ファイルのアップロード
              </label>
              <input type="file" class="form-control" id="fileUpload" @change="handleFiles" multiple />
              <div class="form-text">
                メールのやり取り、契約書類、スクリーンショット、動画などをアップロードできます（複数選択可能）
              </div>
              <!-- 選択されたファイルリスト -->
              <template x-if="formData.fileDataList && formData.fileDataList.length > 0">
                <div class="mt-2">
                  <div class="small text-muted mb-1">選択されたファイル:</div>
                  <ul class="list-group">
                    <template x-for="(file, index) in formData.fileDataList" :key="index">
                      <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                        <span class="small" x-text="file.name"></span>
                        <button type="button" class="btn btn-sm btn-outline-danger" @click="removeFile(index)">
                          <i class="bi bi-x"></i>
                        </button>
                      </li>
                    </template>
                  </ul>
                </div>
              </template>
            </div>

            <hr class="my-4" />

            <!-- 送信ボタン -->
            <div class="d-grid gap-2 d-md-flex justify-content-md-center">
              <button type="submit" class="btn btn-primary btn-lg px-4" :disabled="submitting">
                <span x-show="!submitting">
                  <i class="bi bi-check-circle-fill me-2"></i>
                  登録する
                </span>
                <span x-show="submitting">
                  <span class="spinner-border spinner-border-sm me-2"></span>
                  送信中...
                </span>
              </button>
              <button type="button" class="btn btn-outline-secondary btn-lg px-4" @click="resetForm()"
                :disabled="submitting">
                <i class="bi bi-arrow-clockwise me-2"></i>
                リセット
              </button>
            </div>
          </form>

          <!-- 送信成功メッセージとAI改善案 -->
          <template x-if="success">
            <div class="mt-4">
              <div class="alert alert-success d-flex align-items-center" role="alert">
                <i class="bi bi-check-circle-fill me-2"></i>
                <strong>インシデント情報の登録が完了しました！</strong>
              </div>

              <!-- AI改善案 -->
              <template x-if="improvementSuggestions">
                <div class="card border-primary mt-3">
                  <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                      <i class="bi bi-lightbulb-fill me-2"></i>
                      AI改善案
                    </h5>
                  </div>
                  <div class="card-body">
                    <div class="text-pre-wrap" x-text="improvementSuggestions" style="white-space: pre-wrap;"></div>
                  </div>
                  <div class="card-footer">
                    <button class="btn btn-primary" @click="backToList()">
                      <i class="bi bi-arrow-left me-2"></i>
                      一覧へ戻る
                    </button>
                  </div>
                </div>
              </template>
            </div>
          </template>
        </div>
      </div>
    </div>
  </div>

  <!-- フッター -->
  <footer class="mt-5 pt-4 pb-3 border-top">
    <div class="container text-center text-muted small" style="max-width: 1200px">
      <p class="mb-0">&copy; 2025 Cell Promote Inc. (Coco Incident). All rights reserved.</p>
    </div>
  </footer>

  <script>
    function incidentApp() {
      return {
        // ビュー管理
        currentView: "list", // "list" or "form"

        // データ管理
        incidents: [],
        loading: false,
        error: "",

        // フォーム管理
        submitting: false,
        success: false,
        improvementSuggestions: "",
        formData: {
          registeredDate: "", // 編集モードの場合に設定される（識別子として使用）
          caseName: "",
          assignee: "",
          summary: "",
          stakeholders: "",
          details: "",
          fileDataList: [],
        },

        // 初期化
        init() {
          this.loadIncidents();
        },

        // インシデント一覧を読み込み
        loadIncidents() {
          this.loading = true;
          this.error = "";

          google.script.run
            .withSuccessHandler((result) => {
              this.incidents = result;
              this.loading = false;
            })
            .withFailureHandler((error) => {
              this.error = "データの読み込みに失敗しました: " + error.message;
              this.loading = false;
            })
            .getIncidentList();
        },

        // 新規起票画面を表示
        showForm() {
          this.resetForm();
          this.currentView = "form";
          this.scrollToTop();
        },

        // インシデント編集（カードクリック時）
        editIncident(incident) {
          this.formData.registeredDate = incident.registeredDate; // 編集対象を識別
          this.formData.caseName = incident.caseName;
          this.formData.assignee = incident.assignee;
          this.formData.summary = incident.summary;
          this.formData.stakeholders = incident.stakeholders;
          this.formData.details = incident.details;
          this.formData.fileDataList = [];
          this.currentView = "form";
          this.scrollToTop();
        },

        // 一覧画面に戻る
        backToList() {
          this.currentView = "list";
          this.scrollToTop();
        },

        // ページトップへスクロール
        scrollToTop() {
          window.scrollTo({ top: 0, behavior: "smooth" });
        },

        // ファイル選択時の処理（複数ファイル対応）
        handleFiles(event) {
          const files = Array.from(event.target.files);
          if (files.length === 0) {
            return;
          }

          // 各ファイルをBase64に変換
          const promises = files.map((file) => {
            return new Promise((resolve) => {
              const reader = new FileReader();
              reader.onload = (e) => {
                resolve({
                  name: file.name,
                  mimeType: file.type,
                  data: e.target.result.split(",")[1], // Base64 part
                });
              };
              reader.readAsDataURL(file);
            });
          });

          Promise.all(promises).then((fileDataArray) => {
            this.formData.fileDataList = fileDataArray;
          });
        },

        // ファイルを削除
        removeFile(index) {
          this.formData.fileDataList.splice(index, 1);
          // リストが空になったらinputもリセット
          if (this.formData.fileDataList.length === 0) {
            const fileInput = document.getElementById("fileUpload");
            if (fileInput) {
              fileInput.value = "";
            }
          }
        },

        // フォーム送信
        submitIncident() {
          this.submitting = true;
          this.error = "";
          this.success = false;

          google.script.run
            .withSuccessHandler((result) => {
              this.submitting = false;
              this.success = true;
              // AI改善案を保存
              this.improvementSuggestions = result.improvementSuggestions || "";

              // 編集モードの場合は既存レコードを更新、新規の場合は先頭に追加
              if (this.formData.registeredDate) {
                // 編集モード: 既存レコードを検索して更新
                const index = this.incidents.findIndex(
                  (inc) => inc.registeredDate === this.formData.registeredDate
                );
                if (index !== -1) {
                  this.incidents[index] = result.record;
                }
              } else {
                // 新規作成: 配列の先頭に追加
                this.incidents.unshift(result.record);
              }
            })
            .withFailureHandler((error) => {
              this.error = "送信に失敗しました: " + error.message;
              this.submitting = false;
            })
            .submitIncident(this.formData);
        },

        // フォームをリセット
        resetForm() {
          this.formData.registeredDate = "";
          this.formData.caseName = "";
          this.formData.assignee = "";
          this.formData.summary = "";
          this.formData.stakeholders = "";
          this.formData.details = "";
          this.formData.fileDataList = [];
          const fileInput = document.getElementById("fileUpload");
          if (fileInput) {
            fileInput.value = "";
          }
          this.error = "";
          this.success = false;
          this.improvementSuggestions = "";
        },
      };
    }
  </script>
</body>

</html>